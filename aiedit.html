<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Edit</title>
    <style>
      :root {
        --bg-color: #1e1e1e;
        --gutter-color: #171717;
        --sidebar-bg: #141414;
        --text-color: #d4d4d4;
        --caret-color: #aeafad;
        --accent-color: #4fc1ff;
        --border-color: #333;
        --toast-bg-success: #2d2d2d;
        --toast-text-success: #fff;
        --toast-bg-error: #8b0000;
        --toast-text-error: #fff;
      }

      * {
        box-sizing: border-box;
      }

      body,
      html {
        margin: 0;
        padding: 0;
        height: 100%;
        width: 100%;
        background-color: var(--gutter-color);
        overflow: hidden;
        font-family: 'Courier New', Courier, monospace;
      }

      #container {
        display: flex;
        width: 100%;
        height: 100%;
      }

      #sidebar {
        width: 300px;
        background-color: var(--sidebar-bg);
        display: flex;
        flex-direction: column;
        border-right: 1px solid var(--border-color);
        flex-shrink: 0;
        transition: width 0.2s;
      }

      #sidebar.collapsed {
        width: 0;
        border: none;
        overflow: hidden;
      }

      #chat-header {
        padding: 10px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      #model-selector {
        background: transparent;
        color: #888;
        border: none;
        font-family: inherit;
        font-size: 12px;
        width: 100%;
        outline: none;
        cursor: pointer;
      }

      #chat-history {
        flex-grow: 1;
        overflow-y: auto;
        padding: 15px;
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      #chat-history::-webkit-scrollbar {
        width: 8px;
      }

      #chat-history::-webkit-scrollbar-thumb {
        background: #333;
        border-radius: 4px;
      }

      #chat-input-area {
        padding: 15px;
        border-top: 1px solid var(--border-color);
        position: relative;
        background: var(--sidebar-bg);
      }

      #chat-input {
        width: 100%;
        background: #252525;
        border: 1px solid #333;
        color: var(--text-color);
        padding: 10px;
        border-radius: 4px;
        resize: none;
        font-family: inherit;
        height: 120px;
        outline: none;
      }

      #resize-handle {
        position: absolute;
        top: 0;
        right: 0;
        width: 30px;
        height: 15px;
        cursor: ns-resize;
        background-color: transparent;
        z-index: 10;
      }

      #resize-handle::after {
        content: '';
        position: absolute;
        top: 6px;
        right: 10px;
        width: 12px;
        height: 2px;
        background: #555;
        box-shadow: 0 3px 0 #555;
      }

      #resize-handle:hover::after {
        background: var(--accent-color);
        box-shadow: 0 3px 0 var(--accent-color);
      }

      #chat-input:focus {
        border-color: #555;
      }

      .chat-msg {
        font-size: 13px;
        line-height: 1.4;
        color: #ccc;
        word-wrap: break-word;
      }

      .chat-user {
        color: var(--accent-color);
        font-weight: bold;
        margin-bottom: 2px;
      }

      .chat-ai {
        color: #d4d4d4;
      }

      .chat-code-block {
        background: #000;
        border: 1px solid #333;
        margin-top: 10px;
        border-radius: 4px;
        overflow: hidden;
      }

      .chat-code-header {
        background: #222;
        padding: 5px;
        display: flex;
        justify-content: flex-end;
        border-bottom: 1px solid #333;
      }

      .apply-btn {
        background: #2d4f2d;
        color: #fff;
        border: none;
        padding: 4px 10px;
        font-size: 11px;
        cursor: pointer;
        font-family: inherit;
        border-radius: 2px;
      }

      .apply-btn:hover {
        background: #3d6f3d;
      }

      #gutter {
        width: 24px;
        background-color: var(--gutter-color);
        flex-shrink: 0;
        border-right: 1px solid #252525;
        cursor: pointer;
      }

      #editor {
        flex-grow: 1;
        height: 100%;
        background-color: var(--bg-color);
        color: var(--text-color);
        border: none;
        outline: none;
        resize: none;
        font-size: 16px;
        line-height: 1.5;
        padding: 20px 20px 20px 8px;
        caret-color: var(--caret-color);
        white-space: pre;
        overflow: auto;
      }

      #editor.wrap {
        white-space: pre-wrap;
        word-break: break-all;
      }

      #editor::-webkit-scrollbar {
        width: 12px;
        height: 12px;
      }

      #editor::-webkit-scrollbar-thumb {
        background: #333;
        border-radius: 6px;
        border: 2px solid var(--bg-color);
      }

      #editor::-webkit-scrollbar-track {
        background: var(--bg-color);
      }

      #editor::-webkit-scrollbar-corner {
        background: var(--bg-color);
      }

      #toast {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 10px 20px;
        border-radius: 4px;
        font-size: 14px;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease-in-out;
        z-index: 1000;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        white-space: nowrap;
      }

      #toast.show {
        opacity: 1;
      }

      #toast.success {
        background-color: var(--toast-bg-success);
        color: var(--toast-text-success);
        border: 1px solid #444;
        left: auto;
        width: auto;
        text-align: left;
      }

      #toast.error {
        background-color: var(--toast-bg-error);
        color: var(--toast-text-error);
        font-weight: bold;
        left: auto;
        width: auto;
        text-align: left;
      }

      #toast.help {
        background-color: #252526;
        color: #ccc;
        bottom: 0;
        right: 0;
        left: 0;
        width: 100%;
        border-radius: 0;
        border-top: 1px solid #333;
        text-align: center;
        padding: 12px;
      }

      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 2000;
        display: flex;
        justify-content: center;
        align-items: center;
      }
    </style>
  </head>
  <body>
    <div id="container">
      <div id="sidebar">
        <div id="chat-header">
          <select id="model-selector">
            <option>Loading...</option>
          </select>
          <button id="setup-btn" style="background:none; border:none; color:#666; cursor:pointer; font-size:14px;">⚙️</button>
        </div>
        <div id="chat-history"></div>
        <div id="chat-input-area">
          <textarea id="chat-input" placeholder="Ask AI to change code... (Enter to send)"></textarea>
        </div>
      </div>
      <div id="gutter"></div>
      <textarea id="editor" spellcheck="false" autofocus></textarea>
    </div>
    <div id="toast"></div>
    <script>
      const editor = document.getElementById('editor');
      const gutter = document.getElementById('gutter');
      const toast = document.getElementById('toast');
      const sidebar = document.getElementById('sidebar');
      let fileHandle = null;
      let originalContent = '';
      let fileName = 'index.html';
      let toastTimeout;
      const SNAP_THRESHOLD = 5;
      editor.addEventListener('scroll', () => {
        if (editor.scrollLeft > 0 && editor.scrollLeft < SNAP_THRESHOLD) {
          editor.scrollLeft = 0;
        }
      });
      const updateTitle = () => {
        const isDirty = editor.value !== originalContent;
        document.title = (isDirty ? '*' : '') + fileName;
      };
      const showToast = (message, type = 'success', duration = 2000) => {
        toast.className = '';
        clearTimeout(toastTimeout);
        toast.textContent = message;
        toast.classList.add(type);
        toast.classList.add('show');
        toastTimeout = setTimeout(() => {
          toast.classList.remove('show');
        }, duration);
      };
      const toggleWrap = () => {
        editor.classList.toggle('wrap');
        const isWrapped = editor.classList.contains('wrap');
        showToast(`Line wrap: ${isWrapped ? 'ON' : 'OFF'}`, 'success', 2000);
      };
      const toggleSidebar = () => {
        sidebar.classList.toggle('collapsed');
      };
      const getFileContent = async (handle) => {
        const file = await handle.getFile();
        return await file.text();
      };
      const newFile = async () => {
        if (editor.value !== originalContent) {
          if (!confirm('You have unsaved changes. Discard them?')) return;
        }
        editor.value = '';
        originalContent = '';
        fileHandle = null;
        fileName = 'Untitled';
        updateTitle();
        editor.focus();
      };
      const openFile = async () => {
        if (editor.value !== originalContent) {
          if (!confirm('You have unsaved changes. Discard them?')) return;
        }
        try {
          [fileHandle] = await window.showOpenFilePicker({
            types: [{
              description: 'Code Files',
              accept: {
                'text/plain': ['.html', '.css', '.js', '.txt', '.json', '.md']
              }
            }]
          });
          const content = await getFileContent(fileHandle);
          editor.value = content;
          originalContent = content;
          fileName = fileHandle.name;
          updateTitle();
        } catch (err) {}
      };
      const saveFile = async (saveAs = false) => {
        try {
          if (!fileHandle || saveAs) {
            fileHandle = await window.showSaveFilePicker({
              suggestedName: fileName,
              types: [{
                description: 'Code Files',
                accept: {
                  'text/plain': ['.html', '.css', '.js', '.txt']
                }
              }]
            });
          }
          const writable = await fileHandle.createWritable();
          await writable.write(editor.value);
          await writable.close();
          originalContent = editor.value;
          fileName = fileHandle.name;
          updateTitle();
          showToast('Saved ' + fileName, 'success', 2000);
        } catch (err) {
          if (err.name !== 'AbortError') {
            console.error(err);
            showToast('SAVING FAILED', 'error', 3000);
          }
        }
      };
      const previewFile = () => {
        const win = window.open('', '_blank');
        if (win) {
          win.document.open();
          win.document.write(editor.value);
          win.document.close();
        }
      };
      const showHelp = () => {
        const shortcuts = "Alt+O: Open | Alt+S: Save | Alt+N: New | Alt+P: Preview | Alt+B: Wrap | Alt+J: Toggle AI | Alt+H: Help";
        showToast(shortcuts, 'help', 10000);
      };
      class GeminiBrain {
        constructor() {
          this.apiKey = null;
          this.savedModel = null;
          this.chatHistory = [];
          this.historyDiv = document.getElementById('chat-history');
          this.input = document.getElementById('chat-input');
          this.updateSelector("Setup Required ➡️");
          this.input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
              e.preventDefault();
              this.sendUserMessage();
            }
          });
          document.getElementById('setup-btn').addEventListener('click', () => this.showSetupModal());
          this.setupResizeHandle();
          this.initData();
        }
        initData() {
          const storedKey = localStorage.getItem('gemini_key');
          if (storedKey && storedKey.trim().length > 5) {
            this.apiKey = storedKey;
          }
          this.savedModel = localStorage.getItem('gemini_model');
          if (this.apiKey) {
            this.fetchModels();
          }
        }
        setupResizeHandle() {
          const inputArea = document.getElementById('chat-input-area');
          const handle = document.createElement('div');
          handle.id = 'resize-handle';
          handle.title = 'Drag to resize';
          inputArea.appendChild(handle);
          let startY, startHeight;
          const doDrag = (e) => {
            const delta = startY - e.clientY;
            const newHeight = startHeight + delta;
            if (newHeight > 60 && newHeight < window.innerHeight - 100) {
              this.input.style.height = `${newHeight}px`;
            }
          };
          const stopDrag = () => {
            document.documentElement.removeEventListener('mousemove', doDrag);
            document.documentElement.removeEventListener('mouseup', stopDrag);
          };
          handle.addEventListener('mousedown', (e) => {
            startY = e.clientY;
            startHeight = parseInt(window.getComputedStyle(this.input).height, 10);
            document.documentElement.addEventListener('mousemove', doDrag);
            document.documentElement.addEventListener('mouseup', stopDrag);
            e.preventDefault();
          });
        }
        updateSelector(text, value = "") {
          const selector = document.getElementById('model-selector');
          if (selector) selector.innerHTML = `<option value="${value}" disabled selected>${text}</option>`;
        }
        appendMessage(role, text) {
          const msgDiv = document.createElement('div');
          msgDiv.className = `chat-msg chat-${role}`;
          if (role === 'ai') {
            const parts = text.split(/```(\w*)\n?([\s\S]*?)```/g);
            if (parts.length === 1) {
              msgDiv.textContent = text;
            } else {
              for (let i = 0; i < parts.length; i++) {
                const content = parts[i];
                if (!content) continue;
                if (i % 3 === 0) {
                  const textSpan = document.createElement('div');
                  textSpan.textContent = content;
                  msgDiv.appendChild(textSpan);
                } else if (i % 3 === 2) {
                  const wrapper = document.createElement('div');
                  wrapper.className = 'chat-code-block';
                  const header = document.createElement('div');
                  header.className = 'chat-code-header';
                  const btn = document.createElement('button');
                  btn.className = 'apply-btn';
                  btn.innerHTML = 'Apply Full Update ⚡';
                  btn.onclick = () => {
                    if (confirm('Replace entire editor content with this code?')) {
                      editor.value = content;
                      updateTitle();
                      showToast('Code Applied!', 'success');
                    }
                  };
                  header.appendChild(btn);
                  wrapper.appendChild(header);
                  msgDiv.appendChild(wrapper);
                }
              }
            }
          } else {
            msgDiv.textContent = 'You: ' + text;
          }
          this.historyDiv.appendChild(msgDiv);
          this.historyDiv.scrollTop = this.historyDiv.scrollHeight;
        }
        async sendUserMessage() {
          const text = this.input.value.trim();
          if (!text) return;
          if (!this.apiKey) {
            this.showSetupModal();
            return;
          }
          this.appendMessage('user', text);
          this.input.value = '';
          const loadingId = 'loading-' + Date.now();
          const loadingDiv = document.createElement('div');
          loadingDiv.id = loadingId;
          loadingDiv.className = 'chat-msg chat-ai';
          loadingDiv.textContent = 'Thinking...';
          this.historyDiv.appendChild(loadingDiv);
          try {
            const currentCode = editor.value;
            const prompt = `PROJECT CONTEXT (Single File):\n\`\`\`\n${currentCode}\n\`\`\`\n\nUSER REQUEST: ${text}`;
            const payload = {
              contents: [{
                role: 'user',
                parts: [{
                  text: prompt
                }]
              }],
              system_instruction: {
                parts: [{
                  text: `SYSTEM: You are an expert coding assistant for a single-file web editor.
                1. Always reply with the FULL, COMPLETE updated file code inside a code block if changes are needed. 
                2. Do not use partial snippets. Return the entire file so it can be auto-replaced.
                3. Keep conversational text brief.`
                }]
              }
            };
            const selector = document.getElementById('model-selector');
            const modelName = selector.value || 'gemini-1.5-flash';
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${this.apiKey}`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(payload)
            });
            if (!response.ok) throw new Error('API Error');
            const data = await response.json();
            const aiText = data.candidates[0].content.parts[0].text;
            document.getElementById(loadingId).remove();
            this.appendMessage('ai', aiText);
          } catch (e) {
            console.error(e);
            document.getElementById(loadingId).textContent = 'Error: ' + e.message;
          }
        }
        async fetchModels() {
          const selector = document.getElementById('model-selector');
          try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${this.apiKey}`);
            const data = await response.json();
            const models = data.models
              .filter(m => m.supportedGenerationMethods.includes("generateContent") && m.name.includes("gemini"))
              .map(m => m.name.replace('models/', ''));
            selector.innerHTML = '';
            models.forEach(m => {
              const opt = document.createElement('option');
              opt.value = m;
              opt.text = m;
              selector.appendChild(opt);
            });
            if (this.savedModel) selector.value = this.savedModel;
            selector.onchange = () => {
              localStorage.setItem('gemini_model', selector.value);
              this.savedModel = selector.value;
            };
          } catch (e) {
            this.updateSelector("Error loading models");
          }
        }
        showSetupModal() {
          const existing = document.getElementById('ai-modal');
          if (existing) existing.remove();
          const modal = document.createElement('div');
          modal.id = 'ai-modal';
          modal.className = 'modal-overlay';
          modal.innerHTML = `
          <div style="background:#1e1e1e; padding:20px; border:1px solid #333; width:400px; box-shadow:0 10px 30px #000;">
            <h3 style="margin-top:0; color:#4fc1ff;">AI Setup</h3>
            <p style="color:#ccc; font-size:12px;">Get key from <a href="https://aistudio.google.com/api-keys" target="_blank" style="color:#fff;">Google AI Studio</a></p>
            <input id="ai-key-input" type="password" placeholder="Paste API Key" style="width:100%; padding:8px; background:#252525; border:1px solid #333; color:#fff; margin-bottom:10px;">
            <button id="ai-save" style="background:#4fc1ff; border:none; padding:8px 15px; cursor:pointer;">Save</button>
            <button id="ai-cancel" style="background:none; border:none; color:#888; cursor:pointer;">Cancel</button>
          </div>
        `;
          document.body.appendChild(modal);
          document.getElementById('ai-cancel').onclick = () => modal.remove();
          document.getElementById('ai-save').onclick = () => {
            const key = document.getElementById('ai-key-input').value.trim();
            if (key) {
              this.apiKey = key;
              localStorage.setItem('gemini_key', key);
              this.fetchModels();
              modal.remove();
              showToast('AI Connected', 'success');
            }
          };
        }
      }
      const gemini = new GeminiBrain();
      window.addEventListener('keydown', async (e) => {
        if (e.altKey) {
          switch (e.key.toLowerCase()) {
            case 'o':
              e.preventDefault();
              await openFile();
              break;
            case 's':
              e.preventDefault();
              await saveFile(e.shiftKey);
              break;
            case 'n':
              e.preventDefault();
              await newFile();
              break;
            case 'p':
              e.preventDefault();
              previewFile();
              break;
            case 'b':
              e.preventDefault();
              toggleWrap();
              break;
            case 'h':
              e.preventDefault();
              showHelp();
              break;
            case 'j':
              e.preventDefault();
              toggleSidebar();
              break;
          }
        }
      });
      editor.addEventListener('input', updateTitle);
      window.addEventListener('beforeunload', (e) => {
        if (editor.value !== originalContent) {
          e.preventDefault();
          e.returnValue = '';
        }
      });
      const regainFocus = () => setTimeout(() => editor.focus(), 10);
      window.addEventListener('focus', regainFocus);
      gutter.addEventListener('click', toggleSidebar);
      showHelp();
    </script>
  </body>
</html>
